pipeline {
    agent any

    /****************************************
     * ğŸŒŸ CONFIGURATION SECTION
     ****************************************/
    environment {
        // GitHub & Docker credentials
        GITHUB_TOKEN = credentials('github-token')
        DOCKER_CREDS = credentials('docker-hub-creds')

        // ---- ğŸ”§ General Config ----
        GIT_REPO_URL = "https://github.com/lvoxx/SRMS-backend.git"
        GIT_BRANCH = "main"
        DOCKER_USER_ORG = "lvoxx"  // Docker Hub username/organization
        DOCKER_PREFIX = "srms"      // Prefix for image names

        // ---- ğŸ§© Build Targets ----
        MODULES = "contactor,customer,dashboard,kitchen,order,payment,reporting,warehouse"

        // ---- ğŸ·ï¸ Commit Tag ----
        COMMIT_HASH = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
    }

    options {
        timestamps()
        timeout(time: 2, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
        stage('Checkout') {
            steps {
                echo "ğŸ”¹ Cloning repository..."
                git(
                    url: "${GIT_REPO_URL}",
                    branch: "${GIT_BRANCH}",
                    credentialsId: 'github-token'
                )
                script {
                    echo "ğŸ“Œ Current commit: ${COMMIT_HASH}"
                }
            }
        }

        stage('Run Unit Tests') {
            steps {
                dir('SpringServices') {
                    echo "ğŸ”¹ Running Maven tests from SpringServices root pom.xml"
                    sh 'mvn clean test -B'
                }
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Install JAR Files') {
            steps {
                dir('SpringServices') {
                    echo "ğŸ”¹ Running JAR installation from SpringServices root pom.xml"
                    sh 'mvn clean install -DskipTests -B'
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    dir("SpringServices") {
                        def modules = MODULES.split(',')
                        def buildErrors = []

                        for (module in modules) {
                            def moduleName = module.trim()
                            def imageName = "${DOCKER_USER_ORG}/${DOCKER_PREFIX}-${moduleName}"
                            def taggedNameLatest = "${imageName}:latest"
                            def taggedNameCommit = "${imageName}:${COMMIT_HASH}"

                            echo "ğŸš§ Building Docker image: ${imageName}"

                            try {
                                dir("${moduleName}") {
                                    echo "ğŸ³ Building in directory: ${pwd()}"
                                    sh "docker build -t ${taggedNameLatest} -t ${taggedNameCommit} ."
                                    echo "âœ… Successfully built ${imageName}"
                                }
                            } catch (Exception e) {
                                buildErrors.add("âŒ Failed to build ${moduleName}: ${e.message}")
                                echo "âš ï¸ Error building ${moduleName}, continuing with other modules..."
                            }
                        }

                        if (buildErrors.size() > 0) {
                            error("Build failed for some modules:\n${buildErrors.join('\n')}")
                        }
                    }
                }
            }
        }

        stage('Push Docker Images') {
            steps {
                script {
                    def modules = MODULES.split(',')
                    def pushErrors = []

                    // Login to Docker Hub using withCredentials for security
                    echo "ğŸ”¹ Logging into Docker Hub..."
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-hub-creds',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            echo "$DOCKER_CREDS_PSW" | docker login -u "$DOCKER_CREDS_USR" --password-stdin
                        """
                        
                        for (module in modules) {
                            def moduleName = module.trim().toLowerCase()
                            def imageName = "${DOCKER_USER_ORG}/${DOCKER_PREFIX}-${moduleName}"
                            
                            echo "ğŸ“¦ Pushing ${imageName}:latest and ${imageName}:${COMMIT_HASH}"
                            
                            try {
                                sh """
                                    docker push ${imageName}:latest
                                    docker push ${imageName}:${COMMIT_HASH}
                                """
                                echo "âœ… Successfully pushed ${imageName}"
                            } catch (Exception e) {
                                pushErrors.add("âŒ Failed to push ${moduleName}: ${e.message}")
                                echo "âš ï¸ Error pushing ${moduleName}, continuing with other modules..."
                            }
                        }
                    }

                    if (pushErrors.size() > 0) {
                        error("Push failed for some modules:\n${pushErrors.join('\n')}")
                    }
                }
            }
        }

        stage('Clean Docker Images') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    echo "ğŸ§¹ Cleaning local Docker images to free up space..."
                    def modules = MODULES.split(',')
                    
                    for (module in modules) {
                        def moduleName = module.trim().toLowerCase()
                        def imageName = "${DOCKER_USER_ORG}/${DOCKER_PREFIX}-${moduleName}"
                        
                        try {
                            sh """
                                docker rmi ${imageName}:latest || true
                                docker rmi ${imageName}:${COMMIT_HASH} || true
                            """
                            echo "ğŸ—‘ï¸ Removed local images for ${imageName}"
                        } catch (Exception e) {
                            echo "âš ï¸ Could not remove images for ${moduleName}: ${e.message}"
                        }
                    }
                    
                    // Clean dangling images
                    sh 'docker image prune -f || true'
                    echo "âœ… Docker cleanup completed"
                }
            }
        }

        stage('Clean Workspace') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    echo "ğŸ§¹ Cleaning workspace..."
                    
                    // Clean Maven artifacts
                    dir('SpringServices') {
                        sh 'mvn clean || true'
                    }
                    
                    // Clean workspace
                    cleanWs(
                        deleteDirs: true,
                        disableDeferredWipeout: true,
                        notFailBuild: true,
                        patterns: [
                            [pattern: '**/target/**', type: 'INCLUDE'],
                            [pattern: '**/.git/**', type: 'EXCLUDE']
                        ]
                    )
                    
                    echo "âœ… Workspace cleaned successfully"
                }
            }
        }
    }

    post {
        success {
            echo """
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            âœ… BUILD & PUSH COMPLETED SUCCESSFULLY!
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“¦ Modules built: ${MODULES}
            ğŸ·ï¸  Commit hash: ${COMMIT_HASH}
            ğŸ³ Images pushed to: ${DOCKER_USER_ORG}/${DOCKER_PREFIX}-*
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
        failure {
            echo """
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            âŒ PIPELINE FAILED
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            Check logs above for details.
            Build: ${env.BUILD_NUMBER}
            Commit: ${COMMIT_HASH}
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
        always {
            script {
                echo "ğŸ”š Performing final cleanup..."
                sh 'docker logout || true'
                
                // Additional cleanup if needed
                sh """
                    # Remove any stopped containers
                    docker container prune -f || true
                    
                    # Show disk usage
                    echo "ğŸ’¾ Current Docker disk usage:"
                    docker system df || true
                """
            }
        }
    }
}